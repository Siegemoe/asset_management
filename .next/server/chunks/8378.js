"use strict";exports.id=8378,exports.ids=[8378],exports.modules={58378:(a,b,c)=>{c.d(b,{j2:()=>o,Y9:()=>n});var d=c(35089),e=c(54540),f=c(78105),g=c(93061),h=c(34013),i=c(31001);class j{static{this.config={maxFailedAttempts:5,lockoutDuration:15,progressiveLockout:!0,maxLockoutDuration:1440}}static async recordFailedAttempt(a,b,c,d){console.log("FAILED_LOGIN_ATTEMPT:",{userId:a,email:b,timestamp:new Date().toISOString(),ipAddress:c,userAgent:d})}static async recordLoginAttempt(a,b,c,d,e,f){if(await i.U.logLoginAttempt(a,b,c,d,e,f),c)return{success:!0,shouldLock:!1};if(!a)return{success:!1,shouldLock:!1,reason:"User not found"};await this.recordFailedAttempt(a,b,d,e);let g=await this.getRecentFailedAttempts(a,15);return g>=this.config.maxFailedAttempts?{success:!1,shouldLock:!0,lockoutUntil:new Date(Date.now()+60*this.config.lockoutDuration*1e3),reason:`Account locked for ${this.config.lockoutDuration} minutes due to multiple failed attempts`}:{success:!1,shouldLock:!1,reason:`Invalid credentials (${g+1}/${this.config.maxFailedAttempts} recent attempts)`}}static async getRecentFailedAttempts(a,b){return Date.now(),0}static async isAccountLocked(a){return{locked:!1}}static async unlockAccount(a,b,c,d){try{return await i.U.logSecurityEvent("PASSWORD_CHANGE",a,{action:"unlock_account",unlockedBy:b},c,d),{success:!0,message:"Account unlocked successfully"}}catch(a){return{success:!1,message:"Failed to unlock account"}}}static async getLockoutStatus(a){return{isLocked:!1,recentFailedAttempts:0,maxAttempts:this.config.maxFailedAttempts,config:this.config}}static updateConfig(a){this.config={...this.config,...a}}static getConfig(){return{...this.config}}}var k=c(35324);class l{static{this.rateLimitStore=new Map}static rateLimit(a,b){let c=`rate_limit:${a}`,d=Date.now(),e=this.rateLimitStore.get(c);return!e||d>e.resetTime?(this.rateLimitStore.set(c,{count:1,resetTime:d+b.windowMs}),{allowed:!0,remaining:b.max-1,resetTime:d+b.windowMs}):e.count>=b.max?{allowed:!1,remaining:0,resetTime:e.resetTime,message:b.message||`Rate limit exceeded. Try again in ${Math.ceil((e.resetTime-d)/1e3)} seconds.`}:(e.count++,this.rateLimitStore.set(c,e),{allowed:!0,remaining:b.max-e.count,resetTime:e.resetTime})}static generateCSRFToken(){let a=new Uint8Array(32);return crypto.getRandomValues(a),Array.from(a,a=>a.toString(16).padStart(2,"0")).join("")}static verifyCSRFToken(a){try{let b=a.headers.get("x-csrf-token");if(a.headers.get("origin"),a.headers.get("referer"),!b)return{valid:!1,reason:"CSRF token missing"};if(!/^[a-f0-9]{64}$/.test(b))return{valid:!1,reason:"Invalid CSRF token format"};return{valid:!0}}catch(a){return{valid:!1,reason:"CSRF validation error"}}}static validateOrigin(a,b){let c=a.headers.get("origin"),d=a.headers.get("referer");if(!c&&!d)return{valid:!0};let e=c||d;if(!e)return{valid:!1,reason:"No origin or referer header"};let f=new URL(e).hostname,g=b.some(a=>a===f||!!a.startsWith("*.")&&f.endsWith(a.substring(2)));return{valid:g,reason:g?void 0:`Origin ${f} not allowed`}}static getSecurityHeaders(){return{"X-Frame-Options":"DENY","X-Content-Type-Options":"nosniff","X-XSS-Protection":"1; mode=block","Strict-Transport-Security":"max-age=31536000; includeSubDomains","Referrer-Policy":"strict-origin-when-cross-origin","Content-Security-Policy":"default-src 'self'; script-src 'self' 'unsafe-inline'; style-src 'self' 'unsafe-inline'; img-src 'self' data: https:; font-src 'self'; connect-src 'self';","Permissions-Policy":"geolocation=(), microphone=(), camera=()"}}static sanitizeString(a,b){if("string"!=typeof a)return"";let c=a.trim().replace(/[\x00-\x1F\x7F]/g,"").replace(/<script\b[^<]*(?:(?!<\/script>)<[^<]*)*<\/script>/gi,"").replace(/<[^>]*>/g,"").replace(/javascript:/gi,"").replace(/data:/gi,"").replace(/vbscript:/gi,"");return b&&c.length>b&&(c=c.substring(0,b)),c}static sanitizeEmail(a){let b=this.sanitizeString(a,254);return/^[^\s@]+@[^\s@]+\.[^\s@]+$/.test(b)?b.toLowerCase():""}static sanitizeUrl(a){let b=this.sanitizeString(a,2048);try{let a=new URL(b);if(!["http:","https:"].includes(a.protocol))return"";return a.toString()}catch{return""}}static validatePasswordStrength(a){let b=[],c=0;a.length>=8&&(c+=20),a.length>=12&&(c+=20),a.length>=16&&(c+=10),/[a-z]/.test(a)&&(c+=10),/[A-Z]/.test(a)&&(c+=10),/\d/.test(a)&&(c+=10),/[!@#$%^&*()_+\-=\[\]{};':"\\|,.<>\/?]/.test(a)&&(c+=10),/(.)\1{2,}/.test(a)&&(c-=10),/123|abc|qwe|asd/i.test(a)&&(c-=15),a.length<8&&b.push("Password must be at least 8 characters long"),/[a-z]/.test(a)||b.push("Include lowercase letters"),/[A-Z]/.test(a)||b.push("Include uppercase letters"),/\d/.test(a)||b.push("Include numbers"),/[!@#$%^&*]/.test(a)||b.push("Include special characters"),/(.)\1{2,}/.test(a)&&b.push("Avoid repeated characters"),/123|abc|qwe|asd/i.test(a)&&b.push("Avoid common patterns");let d=c>=40&&0===b.length;return{score:Math.max(0,Math.min(100,c)),feedback:b,valid:d}}static generateSecureRandomString(a,b){let c=b||"ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789",d="",e=new Uint8Array(a);crypto.getRandomValues(e);for(let b=0;b<a;b++)d+=c.charAt((e[b]||0)%c.length);return d}static async hashWithSalt(a,b){let c=b||await h.Ay.genSalt(12);return{hash:await h.Ay.hash(a,c),salt:c}}static async verifyHash(a,b,c){return await h.Ay.compare(a,b)}static detectSuspiciousPatterns(a){let b=[],c=[/(\b(SELECT|INSERT|UPDATE|DELETE|DROP|CREATE|ALTER|EXEC|UNION)\b)/gi,/('|(\\)|(--|#|\/\*))/gi,/((\%27)|(\'))((\%6F)|o|(\%4F))((\%72)|r|(\%52))/gi],d=[/<script\b[^<]*(?:(?!<\/script>)<[^<]*)*<\/script>/gi,/<iframe\b[^<]*(?:(?!<\/iframe>)<[^<]*)*<\/iframe>/gi,/javascript:/gi,/on\w+\s*=/gi],e=[/\.\./g,/[\\/]/g];return[...c,...d,...e,/;|\||&&|\|\|/g,/[`$]/g].forEach((f,g)=>{if(f.test(a)){let a=g<c.length?"SQL injection":g<c.length+d.length?"XSS":g<c.length+d.length+e.length?"Path traversal":"Command injection";b.push(a)}}),{suspicious:b.length>0,patterns:b}}static logSecurityEvent(a,b={},c="MEDIUM"){console.log("SECURITY:",{timestamp:new Date().toISOString(),event:a,severity:c,details:b})}static cleanupRateLimitStore(){let a=Date.now();for(let[b,c]of this.rateLimitStore.entries())a>c.resetTime&&this.rateLimitStore.delete(b)}}var m=c(93699);let{handlers:n,auth:o,signIn:p,signOut:q}=(0,d.Ay)({providers:[(0,e.A)({clientId:m.fl.googleClientId,clientSecret:m.fl.googleClientSecret}),(0,f.A)({name:"credentials",credentials:{email:{label:"Email",type:"email"},password:{label:"Password",type:"password"}},async authorize(a,b){let c=b?.headers?.get("x-forwarded-for")||b?.headers?.get("x-real-ip")||"unknown",d=b?.headers?.get("user-agent")||"unknown";if(console.log("\uD83D\uDD0D Enhanced authentication attempt:",{hasEmail:!!a?.email,hasPassword:!!a?.password,email:a?.email,ipAddress:c,userAgent:d}),!a||"string"!=typeof a.email||"string"!=typeof a.password)return console.log("❌ Invalid credentials format"),null;let e=await g.z.user.findUnique({where:{email:a.email.toLowerCase()}});if(!e)return console.log("❌ User not found"),await i.U.logLoginAttempt(void 0,a.email.toLowerCase(),!1,c,d,"User not found"),null;if(!e.password)return console.log("❌ User has no password set"),await i.U.logLoginAttempt(e.id,e.email,!1,c,d,"No password set"),null;if((await j.isAccountLocked(e.id)).locked)return console.log("❌ Account is locked"),await i.U.logLoginAttempt(e.id,e.email,!1,c,d,"Account locked"),null;let f=await h.Ay.compare(a.password,e.password);if(console.log("\uD83D\uDD10 Password validation:",{valid:f}),!f)return console.log("❌ Invalid password"),await j.recordLoginAttempt(e.id,e.email,!1,c,d,"Invalid password"),null;let m=await k.C.checkSuspiciousActivity(e.id,c,d);m.suspicious&&(console.log("⚠️ Suspicious activity detected:",m.reasons),await i.U.logSecurityEvent("UNAUTHORIZED_ACCESS",e.id,{reasons:m.reasons,ipAddress:c,userAgent:d,eventType:"SUSPICIOUS_LOGIN"},c,d));let n=l.generateSecureRandomString(32),o=l.generateSecureRandomString(32);await k.C.createSession(e.id,n,o,`Browser: ${d.substring(0,50)}`,c,d),await i.U.logLoginAttempt(e.id,e.email,!0,c,d,"Successful login");let p={id:e.id,email:e.email,name:e.name,role:e.role,siteIds:e.siteIds,sessionToken:n,refreshToken:o};return console.log("✅ Enhanced authentication successful for user:",e.email),p}})],callbacks:{session:async({session:a,token:b})=>(a.user&&b&&(a.user.id=b.sub,a.user.role=b.role||"SITE_MANAGER",a.user.siteIds=b.siteIds?JSON.parse(b.siteIds):[]),a),jwt:async({token:a,user:b})=>(b&&(a.id=b.id,a.role=b.role,a.siteIds=b.siteIds),a)},pages:{signIn:"/login"},session:{strategy:"jwt"}})}};